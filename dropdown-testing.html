<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Covid-19 Tracking App</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css"
    />
    <link rel="stylesheet" href="./assets/css/styles.css" />
  </head>
  <body>
    <!-- final search area -->
    <div id="search-section">
      <input
        class="input mb-2"
        type="text"
        placeholder="Your Search Input"
        id="input"
      />
      <div class="field has-addons" id="option-search">
        <div class="control is-expanded" id="option-div">
          <div class="select is-fullwidth">
            <select name="category" id="category">
              <option value="">Category</option>
              <option value="country">Country</option>
              <option value="province">Province</option>
              <option value="city">County/City</option>
            </select>
          </div>
        </div>
        <div class="control" id="search-div">
          <button type="submit" class="button is-info" id="search-btn">
            Search
          </button>
        </div>
      </div>
    </div>

    <!-- testing div -->
    <div
      class="display-flex is-flex-wrap-wrap is-justify-content-flex-start pl-3 pb-2"
    >
      <div id="flag"></div>
      <h2 id="country-province" class="ml-5 mt-3">ppp</h2>
      <p id="confirm" class="ml-5 mt-5">ttt</p>
    </div>

    <!-- scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
      defer
      src="https://use.fontawesome.com/releases/v5.14.0/js/all.js"
    ></script>
    <script type="text/javascript">
      $("#search-div").on("click", function () {
        console.log("search button clicked");
        let input = $(this).parent().siblings("#input").val();
        console.log("search input is " + input);
        let optionValue = $(this)
          .closest("#option-search")
          .find("#category")
          .val();
        console.log("the category is " + optionValue);

        if ((optionValue = "country")) {
          console.log("yes");
          getCountryData(input);
        }

        // clear the input space after each search
        $(this).parent().siblings("#input").val("");
      });

      function getCountryData(input) {
        fetch("https://www.trackcorona.live/api/countries")
          .then(function (response) {
            if (response.ok) {
              return response.json();
            }
          })
          .then(function (responseJson) {
            console.log(responseJson);
            // Returns all the available province.
            for (let i = 0; i < responseJson.data.length; i++) {
              console.log(responseJson.data.length);

              if (responseJson.data[i].location.includes(input)) {
                let confirm = document.querySelector("#confirm");
                let country = document.querySelector("#country-province");
                let mostRecentData = responseJson.data[i].updated.split(" ")[0];
                country.textContent = responseJson.data[i].location;
                confirm.textContent =
                  mostRecentData +
                  ": " +
                  " Confirmed: " +
                  responseJson.data[i].confirmed +
                  ", " +
                  " Deaths: " +
                  responseJson.data[i].dead +
                  ".";
                // create country flag
                document.querySelector("img")?.remove();
                let flagDiv = document.querySelector("#flag");
                let countryFlag = document.createElement("img");
                countryFlag.setAttribute(
                  "src",
                  "https://www.countryflags.io/" +
                    responseJson.data[i].country_code +
                    "/flat/64.png"
                );
                flagDiv.appendChild(countryFlag);
              }
            }
            console.log("ohyes");
          });
      }
    </script>
  </body>
</html>
